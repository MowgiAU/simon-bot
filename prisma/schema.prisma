// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Guild configuration
model Guild {
  id        String   @id
  name      String
  icon      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members            Member[]
  wordGroups         WordGroup[]
  filterSettings     FilterSettings?
  channelStats       ChannelStats[]
  serverStats        ServerStats[]
  pluginSettings     PluginSettings[]
  dashboardAccess    DashboardAccess?
  actionLogs         ActionLog[]
  userNotes          UserNote[]

  moderationSettings ModerationSettings?

  @@map("guilds")
}

// Moderation Settings
model ModerationSettings {
  id             String   @id @default(cuid())
  guildId        String   @unique
  logChannelId   String?  // Channel to send nice embeds to
  dmUponAction   Boolean  @default(true) // DM user when kicked/banned?

  // Custom Messages
  kickMessage    String?  // e.g. "You were kicked from {server} for: {reason}"
  banMessage     String?
  timeoutMessage String?
  
  permissions    ModerationPermission[]
  
  guild          Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@map("moderation_settings")
}

model ModerationPermission {
  id             String   @id @default(cuid())
  settingsId     String
  roleId         String   // Discord Role ID
  
  // Permissions
  canWarn        Boolean @default(false)
  canKick        Boolean @default(false)
  canBan         Boolean @default(false)
  canTimeout     Boolean @default(false)
  canPurge       Boolean @default(false)
  canViewLogs    Boolean @default(false)
  
  settings       ModerationSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  
  @@unique([settingsId, roleId])
  @@map("moderation_permissions")
}

// Action Logs for Auditing
model ActionLog {
  id         String   @id @default(cuid())
  guildId    String
  pluginId   String   // e.g., 'word-filter', 'moderation'
  action     String   // e.g., 'message_deleted', 'user_banned'
  executorId String?  // ID of user/bot who performed action
  targetId   String?  // ID of user/message/channel affected
  details    Json?    // Context specific data
  searchableText String @default("") // Quick search vector (names, ids, content)
  createdAt  DateTime @default(now())

  guild      Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  comments   LogComment[]

  @@index([guildId, createdAt])
  @@map("action_logs")
}

model LogComment {
  id        String    @id @default(cuid())
  logId     String
  userId    String    // Admin who made the comment
  content   String
  createdAt DateTime  @default(now())

  log       ActionLog @relation(fields: [logId], references: [id], onDelete: Cascade)

  @@index([logId])
  @@map("log_comments")
}

model UserNote {
  id        String    @id @default(cuid())
  guildId   String
  userId    String    // The user being noted on
  adminId   String    // Admin who made the note
  content   String
  createdAt DateTime  @default(now())

  guild     Guild     @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId, userId])
  @@map("user_notes")
}

model ScheduledTask {
  id        String   @id @default(cuid())
  guildId   String
  type      String   // e.g. 'unban'
  targetId  String
  executeAt DateTime
  data      Json?    // e.g. { "reason": "Time Served" }
  createdAt DateTime @default(now())

  @@index([executeAt])
  @@map("scheduled_tasks")
}

// Guild members - leveling, currency, etc.
model Member {
  id        String   @id @default(cuid())
  guildId   String
  userId    String
  
  // Leveling system
  level     Int      @default(1)
  xp        Int      @default(0)
  
  // Currency system
  balance   Int      @default(0)
  
  // Tracking
  lastActiveAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId])
  @@map("members")
}

// Word Filter Plugin
model FilterSettings {
  id           String   @id @default(cuid())
  guildId      String   @unique
  
  // Global settings
  enabled      Boolean  @default(true)
  repostEnabled Boolean @default(true)
  
  // Excluded channels and roles (JSON arrays of IDs)
  excludedChannels String[] @default([])
  excludedRoles    String[] @default([])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  guild        Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  wordGroups   WordGroup[]

  @@map("filter_settings")
}

model WordGroup {
  id           String   @id @default(cuid())
  guildId      String
  name         String   // e.g., "Slurs", "Spam"
  
  // Replacement (word or emoji)
  replacementText String?
  replacementEmoji String?
  useEmoji     Boolean  @default(false)
  enabled      Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  guild        Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  settings     FilterSettings @relation(fields: [guildId], references: [guildId], onDelete: Cascade, map: "word_groups_settings_fkey")
  words        FilterWord[]

  @@unique([guildId, name])
  @@map("word_groups")
}

model FilterWord {
  id        String   @id @default(cuid())
  groupId   String
  word      String
  
  createdAt DateTime @default(now())

  // Relations
  group     WordGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, word])
  @@map("filter_words")
}

// Statistics Models

model ChannelStats {
  id          String   @id @default(cuid())
  guildId     String
  channelId   String
  channelName String
  date        DateTime @db.Date
  messages    Int      @default(0)
  
  guild       Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, channelId, date])
  @@map("channel_stats")
}

model ServerStats {
  id            String   @id @default(cuid())
  guildId       String
  date          DateTime @db.Date
  memberCount   Int      @default(0)
  messageCount  Int      @default(0)
  voiceMinutes  Int      @default(0)
  newBans       Int      @default(0)
  
  guild         Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@unique([guildId, date])
  @@map("server_stats")
}

// Plugin Management
model PluginSettings {
  id             String   @id @default(cuid())
  guildId        String
  pluginId       String
  
  enabled        Boolean  @default(true)
  allowedRoles   String[] @default([]) // Roles that can configure this plugin
  
  guild          Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@unique([guildId, pluginId])
  @@map("plugin_settings")
}

model DashboardAccess {
  id             String   @id @default(cuid())
  guildId        String   @unique
  allowedRoles   String[] @default([]) // Roles that can login to dashboard
  
  guild          Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  
  @@map("dashboard_access")
}

